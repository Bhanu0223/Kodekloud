Task:
Create an inventory file /home/thor/playbook/inventory on jump host and add all app servers in it.


Create an Ansible playbook /home/thor/playbook/playbook.yml to install samba package on all  app servers using Ansible yum module.


Make sure user thor should be able to run the playbook on jump host.

Note: Validation will try to run playbook using command ansible-playbook -i inventory playbook.yml so please make sure playbook works this way, without passing any extra arguments.


###########
sol: 
1. mkdir -p /home/thor/playbook

2. Create /home/thor/playbook/inventory with the following content:
stapp01 ansible_host=172.16.238.10 ansible_user=tony ansible_ssh_pass=Ir0nM@n
stapp02 ansible_host=172.16.238.11 ansible_user=steve ansible_ssh_pass=Am3ric@
stapp03 ansible_host=172.16.238.12 ansible_user=banner ansible_ssh_pass=BigGr33n

if you get this error:fatal: [stapp02]: FAILED! => {"changed": false, "module_stderr": "Shared connection to 172.16.238.11 closed.\r\n", "module_stdout": "", "msg": "MODULE FAILURE\nSee stdout/stderr for the exact error", "rc": 137}

use this: sol for rc: 137 with “Shared connection closed”
[app_servers]
stapp01 ansible_host=172.16.238.10 ansible_user=tony ansible_ssh_pass=Ir0nM@n ansible_become_pass=Ir0nM@n
stapp02 ansible_host=172.16.238.11 ansible_user=steve ansible_ssh_pass=Am3ric@ ansible_become_pass=Am3ric@
stapp03 ansible_host=172.16.238.12 ansible_user=banner ansible_ssh_pass=BigGr33n ansible_become_pass=BigGr33n

Passwordless or ssh keys:
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" ----> This creates:

~/.ssh/id_rsa (private key)
~/.ssh/id_rsa.pub (public key)


ssh-copy-id tony@172.16.238.10
ssh-copy-id steve@172.16.238.11
ssh-copy-id banner@172.16.238.12

Inventory file: 
[app_servers]
stapp01 ansible_host=172.16.238.10 ansible_user=tony
stapp02 ansible_host=172.16.238.11 ansible_user=steve
stapp03 ansible_host=172.16.238.12 ansible_user=banner

If sudo still asks for a password, you can either:
Configure passwordless sudo on the app servers, or
Add --ask-become-pass when running the playbook

Configure passwordless sudo on the app servers:
On each server:
sudo visudo -f /etc/sudoers.d/tony
Add:
tony ALL=(ALL) NOPASSWD: ALL





3. Create /home/thor/playbook/playbook.yml:
---
- name: Install Samba on all app servers
  hosts: app_servers
  become: yes
  tasks:
    - name: Install samba package
      yum:
        name: samba
        state: present


4.Set correct ownership and permissions on the jump host:
chown -R thor:thor /home/thor/playbook
chmod 755 /home/thor
chmod 755 /home/thor/playbook
chmod 644 /home/thor/playbook/inventory
chmod 644 /home/thor/playbook/playbook.yml

5. RUN
cd /home/thor/playbook
ansible-playbook -i inventory playbook.yml


#####################
Since the ZIP file exists only on the jump host (/usr/src/devops/xfusion.zip), the playbook must:

Copy the ZIP file to each app server

Unzip it into /opt/devops/ on each app server

Set ownership based on the server

Ensure extracted files have permission 0744

Create /home/thor/ansible/playbook.yml with this content:

---
- name: Unzip xfusion archive on all app servers
  hosts: all
  become: yes
  tasks:

    - name: Ensure destination directory exists
      file:
        path: /opt/devops
        state: directory
        mode: '0755'

    - name: Copy xfusion.zip to app servers
      copy:
        src: /usr/src/devops/xfusion.zip
        dest: /tmp/xfusion.zip
        mode: '0644'

    - name: Unzip archive on App Server 1
      unarchive:
        src: /tmp/xfusion.zip
        dest: /opt/devops
        remote_src: yes
        owner: tony
        group: tony
        mode: '0744'
      when: inventory_hostname == "stapp01"

    - name: Unzip archive on App Server 2
      unarchive:
        src: /tmp/xfusion.zip
        dest: /opt/devops
        remote_src: yes
        owner: steve
        group: steve
        mode: '0744'
      when: inventory_hostname == "stapp02"

    - name: Unzip archive on App Server 3
      unarchive:
        src: /tmp/xfusion.zip
        dest: /opt/devops
        remote_src: yes
        owner: banner
        group: banner
        mode: '0744'
      when: inventory_hostname == "stapp03"
#########################
---
- name: Install and configure httpd on all app servers
  hosts: all
  become: yes
  tasks:

    - name: Install httpd package
      yum:
        name: httpd
        state: present

    - name: Ensure httpd service is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

    - name: Add sample content to index.html
      blockinfile:
        path: /var/www/html/index.html
        create: yes
        block: |
          Welcome to XfusionCorp!

          This is  Nautilus sample file, created using Ansible!

          Please do not modify this file manually!

    - name: Set ownership on index.html
      file:
        path: /var/www/html/index.html
        owner: apache
        group: apache

    - name: Set permissions on index.html
      file:
        path: /var/www/html/index.html
        mode: '0777'

###################################

The Nautilus application development team has been working on a project repository /opt/media.git. This repo is cloned at /usr/src/kodekloudrepos on storage server in Stratos DC. They recently shared the following requirements with DevOps team:


Create a new branch datacenter in /usr/src/kodekloudrepos/media repo from master and copy the /tmp/index.html file (present on storage server itself) into the repo. Further, add/commit this file in the new branch and merge back that branch into master branch. Finally, push the changes to the origin for both of the branches.
All of this work is done on the storage server, inside the already cloned repository at:

/usr/src/kodekloudrepos/media


Follow these steps on the storage server:

cd /usr/src/kodekloudrepos/media


Make sure you are on master and up to date:

git checkout master
git pull origin master


Create a new branch datacenter from master:

git checkout -b datacenter


Copy the file from /tmp into the repo:

cp /tmp/index.html .


Add and commit the file in the datacenter branch:

git add index.html
git commit -m "Add index.html in datacenter branch"


Push the new branch to origin:

git push origin datacenter


Merge datacenter back into master:

git checkout master
git merge datacenter


Push master to origin:

git push origin master


After this:

datacenter branch contains index.html

master branch also contains index.html

Both branches are pushed to origin as required
#################################

There are some files that need to be created on all app servers in Stratos DC. The Nautilus DevOps team want these files to be owned by user root only however, they also want that the app specific user to have a set of permissions on these files. All tasks must be done using Ansible only, so they need to create a playbook. Below you can find more information about the task.


Create a playbook named playbook.yml under /home/thor/ansible directory on jump host, an inventory file is already present under /home/thor/ansible directory on Jump Server itself.


Create an empty file blog.txt under /opt/devops/ directory on app server 1. Set some acl properties for this file. Using acl provide read '(r)' permissions to group tony (i.e entity is tony and etype is group).


Create an empty file story.txt under /opt/devops/ directory on app server 2. Set some acl properties for this file. Using acl provide read + write '(rw)' permissions to user steve (i.e entity is steve and etype is user).


Create an empty file media.txt under /opt/devops/ on app server 3. Set some acl properties for this file. Using acl provide read + write '(rw)' permissions to group banner (i.e entity is banner and etype is group).


Note: Validation will try to run the playbook using command ansible-playbook -i inventory playbook.yml so please make sure the playbook works this way, without passing any extra arguments.

---
- name: Create files and set ACLs on app servers
  hosts: all
  become: yes
  tasks:

    - name: Ensure /opt/devops directory exists
      file:
        path: /opt/devops
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create blog.txt on App Server 1
      file:
        path: /opt/devops/blog.txt
        state: touch
        owner: root
        group: root
      when: inventory_hostname == "stapp01"

    - name: Set ACL for group tony (read) on blog.txt
      acl:
        path: /opt/devops/blog.txt
        entity: tony
        etype: group
        permissions: r
        state: present
      when: inventory_hostname == "stapp01"

    - name: Create story.txt on App Server 2
      file:
        path: /opt/devops/story.txt
        state: touch
        owner: root
        group: root
      when: inventory_hostname == "stapp02"

    - name: Set ACL for user steve (read+write) on story.txt
      acl:
        path: /opt/devops/story.txt
        entity: steve
        etype: user
        permissions: rw
        state: present
      when: inventory_hostname == "stapp02"

    - name: Create media.txt on App Server 3
      file:
        path: /opt/devops/media.txt
        state: touch
        owner: root
        group: root
      when: inventory_hostname == "stapp03"

    - name: Set ACL for group banner (read+write) on media.txt
      acl:
        path: /opt/devops/media.txt
        entity: banner
        etype: group
        permissions: rw
        state: present
      when: inventory_hostname == "stapp03"

